---
title: "Анализ заболеваемости Covid19"
author: "Юрченков Иван Алескандрович ИММО-01-20"
output: 
  word_document: 
    highlight: haddock
    fig_width: 8
    fig_height: 8
    fig_caption: yes
    keep_md: yes
---

```{r setup, echo = FALSE, include = FALSE}
# Загрузка всех данных и импорт данных в проект и библиотеки ------------------

libraries = c("tidyverse", "openxlsx",
              "dplyr", "tidyr", "stringr",
              "ggplot2", "forecast",
              "openxlsx", "quantreg")

#' Downloading and installing packages in R session
#'
#' @param libs - vector of character libraries that you want to download
#'
#' @return NULL
#' @export
#'
#' @examples
#' install_new_package("ggplot2")
#' install_new_package(c("dplyr", "forecast"))
install_new_package <- function(libs = libraries) {
    for (libI in libs) {
        if (libI %in% installed.packages() == FALSE) {
            install.packages(libI)
        }
    }
}

install_new_package(libs = libraries)

if (!dir.exists("./output_pngs/")) {
  dir.create("./output_pngs")
}


if (!dir.exists("./output_pngs/World")) {
  dir.create("./output_pngs/World")
}
# Подключение пакетов -----------------------------------------------------
library(dplyr)    # Обработка фреймов
library(tidyr)    # Пакет для приведения данных в порядок
library(stringr)  # Пакет для обработки строк
library(openxlsx) # Пакет для экспорта данных в xlsx

# Загрузка данных ---------------------------------------------------------
df <- read.csv(file = "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv")
cat("\nConfid data downloaded!\n")
df_deaths <- read.csv(file = "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv")
cat("\nDeaths data downloaded\n")
df_recovered <- read.csv(file = "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv")
cat("\nRecovered data downloaded\n")
# Исследование данных -----------------------------------------------------

# Имена столбцов показывают, что данные о Covid19 обновляются путём добавления
# столбцов каждый день
#
# Строк 273, что соответствует локациям, в которых проводятся подсчёты
# статистики числа заболевших
#
# О странах известно, в каких точных (до второго знака)
# координатах они находятся
#
# Типы полей - целочисленные


# Слияние колонок страна/регион -------------------------------------------

# Создадим новую колонку из двух старых
df <- tidyr::unite(data = df,
                   col = "Country/Province",
                   sep = "/",
                   Country.Region,
                   Province.State)
df_deaths <- tidyr::unite(data = df_deaths,
                          col = "Country/Province",
                          sep = "/",
                          Country.Region,
                          Province.State)
df_recovered <- tidyr::unite(data = df_recovered,
                             col = "Country/Province",
                             sep = "/",
                             Country.Region,
                             Province.State)

# Создание дополнительного фрейма данных с метаданными о странах ----------

#“Страна/Регион”
#Широта
#Долгота
#Сумма заболевших
#Среднее число заболевших
#Стандартное отклонение числа заболевших

# Сохраним названия в отдельный вектор
country_names <- df$`Country/Province`
country_names_deaths <- df_deaths$`Country/Province`
country_names_recovered <- df_recovered$`Country/Province`

# Сохраним даты в отдельный вектор
test_dates <- colnames(df)[4:ncol(df)]

# Сохраним в отдельный df информацию о странах и описательные статистики
df_meta <- data.frame(df[, 1:3],
                      pos_mean = apply(as.matrix(df[, 4:ncol(df)]), 1, mean),
                      pos_std = apply(as.matrix(df[, 4:ncol(df)]), 1, mean),
                      pos_sum = apply(as.matrix(df[, 4:ncol(df)]), 1, sum))
df_deaths_meta <- data.frame(df_deaths[, 1:3],
                             pos_mean = apply(as.matrix(df[, 4:ncol(df)]), 1, mean),
                             pos_std = apply(as.matrix(df[, 4:ncol(df)]), 1, mean),
                             pos_sum = apply(as.matrix(df[, 4:ncol(df)]), 1, sum))
df_recovered_meta <- data.frame(df[, 1:3],
                                pos_mean = apply(as.matrix(df[, 4:ncol(df)]), 1, mean),
                                pos_std = apply(as.matrix(df[, 4:ncol(df)]), 1, mean),
                                pos_sum = apply(as.matrix(df[, 4:ncol(df)]), 1, sum))


# Создание нового фрейма --------------------------------------------------

# 1. Обработка дат для приведения их к стандартному формату

# Избавимся от лишних символов
test_dates <- gsub("X", "", test_dates)

# Вытащим из вектора дат месяцы, дни и годы
months <- as.numeric(stringr::str_extract(string = test_dates,
                                          pattern = "^\\d+"))

days <- as.numeric(gsub(pattern = "\\.",
                        replacement = "",
                        x = stringr::str_extract(string = test_dates,
                                                 pattern = "\\.\\d+\\.")))

years <- 2000 + as.numeric(gsub(pattern = "\\.",
                                replacement = "",
                                x = stringr::str_extract(string = test_dates,
                                                         pattern = "\\.\\d+$")))

# Преобразуем их к единому формату дат
date_time <- ISOdate(year = years, month = months, day = days)
date <- as.Date(date_time)

# Удаление переменных
rm("months", "days", "years", "test_dates", "date_time")

# 2. Транспонирование данных и приведение к новой таблице на основе исходной
# Измерения в исходном фрейме начинаются с 4 столбца, следовательно
# сделаем выборку всех строк по столбцам с 4 по последний и транспонируем,
# поскольку в пределах данного куска таблицы все данные однотипны
new_table <- data.frame(date = date,
                        t(as.matrix(df[,4:ncol(df)])),
                        row.names = 1:(ncol(df) - 3))
new_table_deaths <- data.frame(date = date,
                               t(as.matrix(df_deaths[,4:ncol(df_deaths)])),
                               row.names = 1:(ncol(df_deaths) - 3))
new_table_recovered <- data.frame(date = date,
                                  t(as.matrix(df_recovered[,4:ncol(df_recovered)])),
                                  row.names = 1:(ncol(df_recovered) - 3))

colnames(new_table) <- c("date", country_names)
colnames(new_table_deaths) <- c("date", country_names_deaths)
colnames(new_table_recovered) <- c("date", country_names_recovered)

# Экспорт -----------------------------------------------------------------
# Экспортируем подготовленные данные в csv-файл
if (!dir.exists("output_csv")) {
  dir.create("output_csv")
}
write.csv(x = new_table,
          file = "output_csv/data_conf_output.csv")
write.csv(x = df_meta,
          file = "output_csv/metadata_conf.csv")
write.csv(x = new_table_deaths,
          file = "output_csv/data_deaths_output.csv")
write.csv(x = df_deaths_meta,
          file = "output_csv/metadata_deaths.csv")
write.csv(x = new_table_recovered,
          file = "output_csv/data_recovered_output.csv")
write.csv(x = df_recovered_meta,
          file = "output_csv/metadata_recovered.csv")


# Экспортируем данные в xlsx
if (!dir.exists("output_xlsx")) {
  dir.create("output_xlsx")
}
openxlsx::write.xlsx(x = new_table,
                     file = "output_xlsx/data_conf_output.xlsx")
openxlsx::write.xlsx(x = df_meta,
                     file = "output_xlsx/metadata_conf.xlsx")
openxlsx::write.xlsx(x = new_table_deaths,
                     file = "output_xlsx/data_deaths_output.xlsx")
openxlsx::write.xlsx(x = df_deaths_meta,
                     file = "output_xlsx/metadata_deaths.xlsx")
openxlsx::write.xlsx(x = new_table_recovered,
                     file = "output_xlsx/data_recovered_output.xlsx")
openxlsx::write.xlsx(x = df_recovered_meta,
                     file = "output_xlsx/metadata_recovered.xlsx")


# Удаление данных сессии --------------------------------------------------
rm(list = ls())

library(dplyr)
library(ggplot2)
library(forecast)

# Импорт подтверждённых заболеваний -------------------------------------------
df_confirmed <- read.csv("./output_csv/data_conf_output.csv")
df_confirmed$date <- as.Date(df_confirmed$date)
df_confirmed$World <- rowSums(df_confirmed[, 3:ncol(df_confirmed)])

# Импорт выздоровлений --------------------------------------------------------
df_recovered <- read.csv("./output_csv/data_recovered_output.csv")
df_recovered$date <- as.Date(df_recovered$date)
df_recovered$World <- rowSums(df_recovered[, 3:ncol(df_recovered)])

# Импорт смертей --------------------------------------------------------------
df_deaths <- read.csv("./output_csv/data_deaths_output.csv")
df_deaths$date <- as.Date(df_deaths$date)
df_deaths$World <- rowSums(df_deaths[, 3:ncol(df_deaths)])
```


# Анализ парных движений на фазовых плоскостях

## Предобследование парной динамики заболеваемости

Рассмотрим динамику заболеваемости Covid19 в двух странах, построим их графики заболеваемости во времени, а также фазовую плоскость. 

На графике динамики двух стран отложим по оси ординат натуральный логарифм ежедневных приростов больных Covid19, по оси абсцисс номер дня с момента начала мирового распространения `r df_confirmed$date[1]`. По данному графику мы сможем визуально оценить модель взаимодействия двух процессов на качественном уровне.

В качестве примера возьмём две страны с открытыми туристическими границами - Египет и Беларусь.


```{r Egypt_Belarus graphics, out.height=800, out.width=800, echo = F, dpi = 512}
time_series_Egypt <- select(df_confirmed, contains("Egypt"))[, ]
time_series_Belarus <- select(df_confirmed, contains("Belarus"))[, ]

plot(x = 1:length(time_series_Belarus), y = c(0, log(diff(time_series_Belarus) + 1)),
     col = "red", type = "o", cex = I(0.5), lwd = I(0.5), pch = 19,
     main = "Парный график заболеваемости Беларусь и Египет",
     ylab = "Натуральный логарифм заболеваний каждый день, чел",
     xlab = paste("Дни с", df_confirmed$date[1]),
     ylim = c(min(c(0, log(diff(time_series_Belarus) + 1)), c(0, log(diff(time_series_Egypt) + 1))), 
              max(c(0, log(diff(time_series_Belarus) + 1)), c(0, log(diff(time_series_Egypt) + 1)))))
lines(x = 1:length(time_series_Egypt), y = c(0, log(diff(time_series_Egypt) + 1)),
      col = "blue", type = "o", cex = I(0.5), lwd = I(0.5), pch = 19)
legend(x = 300, y = 2,
       legend = c("LN приросты Беларусь", "LN приросты Египет"),
       col = c("red", "blue"), lty = c(1, 1), pch = c(19, 19))
abline(h = seq(0, 9, 0.5), lwd = I(0.5), lty = 2, col = "grey")
abline(v = seq(0, length(time_series_Egypt) + 10, 25), lwd = I(0.5), lty = 2, col = "grey")
```

График парной динамики показывает нам, что уровень заболеваемости, длительность тактов вспышек заболеваемости в двух странах находятся примерно на одном уровне. На последнем временном отрезке в 350 дней от начала измерений и до настоящего времени видим на графике динамики заболеваемости в Беларуси появившуюся недельную сезонность - коррекцию на некоторый момент времени, являющуюся ответной реакцией процесса на некоторые структурные изменения механизма измерения числа заболевших. Такое качественное изменение характера динамики процесса может существенно повлиять на дальнейший анализ данного процесса. 

На графике динамики заболеваемости в Египте видим на момент 28.05.2021 начало спада и точку перелома приростов заболевших Covid19, что означает возможное прохождение точки максимума заражений во время 3 волны массовых заражений.

Оценим длительность тактов переходных процессов спада и роста количества заболевших относительно точек максимума заражений на графике заболеваемости в Египте.

```{r Egypt takt, out.height=800, out.height=800, echo=F, dpi = 512}
maxes_Egypt <- c(148, 345, 480)
tau = 30

plot(x = 1:length(time_series_Belarus), y = c(0, log(diff(time_series_Belarus) + 1)),
     col = "red", type = "o", cex = I(0.5), lwd = I(0.5), pch = 19,
     main = "Анализ тактов заболеваемости парного процесса",
     ylab = "Натуральный логарифм заболеваний каждый день, чел",
     xlab = paste("Дни с", df_confirmed$date[1]),
     ylim = c(min(c(0, log(diff(time_series_Belarus) + 1)), c(0, log(diff(time_series_Egypt) + 1))), 
              max(c(0, log(diff(time_series_Belarus) + 1)), c(0, log(diff(time_series_Egypt) + 1)))))
lines(x = 1:length(time_series_Egypt), y = c(0, log(diff(time_series_Egypt) + 1)),
      col = "blue", type = "o", cex = I(0.5), lwd = I(0.5), pch = 19)
abline(h = seq(0, 9, 0.5), lwd = I(0.5), lty = 2, col = "grey")
abline(v = seq(0, length(time_series_Egypt) + 10, 25), lwd = I(0.5), lty = 2, col = "grey")
abline(v = maxes_Egypt, col = "orange2")
text(x = maxes_Egypt, y = 3.5, labels = df_confirmed$date[1] - 1 + maxes_Egypt)
abline(v = maxes_Egypt - tau, col = "green3")
text(x = maxes_Egypt - tau, y = 2.5, labels = df_confirmed$date[1] - 1 + maxes_Egypt - tau)
legend(x = 300, y = 2,
       legend = c("LN приросты Беларусь", "LN приросты Египет"),
       col = c("red", "blue"), lty = c(1, 1), pch = c(19, 19))
abline(h = c(4.5, 7.5), col = "blue", lty = 2)
abline(h = c(4.9, 6.9), col = "red", lty = 2)

abline(h = 0)
```

Из расставленных точек максимума заболеваемости на графиках по Беларуси и Египту видим что в начале процесса существовал некоторый почти-периодический процесс с обеих сторон с лагом между процессами в `r tau` дней. Также видим что из-за структурного изменения процесса измерения числа заболевших в Беларуси такого эффекта не наблюдалось в последнюю волну. 

Для завершения исследования парного развития процесса заболеваемости в двух странах необходимо провести анализ динамики на фазовой плоскости динамик процессов. Произведём построение графика с осью ординат - заболеваемостью в Египте, и осью абсцисс - заболеваемостью в Беларуси:

```{r , dpi = 512, echo = F}
plot(y = log(diff(time_series_Egypt) + 1), x = log(diff(time_series_Belarus) + 1),
     xlab = "Динамика заболеваемости в Беларуси в полулогарифмах",
     ylab = "Динамика заболеваемости в Египте в полулогарифмах",
     main = "График фазовой плоскости парной динамики",
     type = "p", 
     pch = 19, 
     lwd = I(0.5),
     cex = I(0.5))

radius_a = 0.9
radius_b = 1.2
center_x = 6
center_y = 6.1
points(x = c(center_x - radius_a, center_x, center_x + radius_a, center_x, center_x) - 0.1, 
       y = c(center_y, center_y, center_y, center_y + radius_b, center_y - radius_b), pch = 19, cex = I(1), col = "red")
abline(h = c(4.5, 7.5), col = "blue", lty = 2)
abline(v = c(4.9, 6.9), col = "red", lty = 2)
graphics::rect(6.9, 4.5, 9, 7.5, col = "blue", density = I(10))
```

На фазовой плоскости динамики двух процессов наблюдаем замкнутый контур завершённого полного такта взаимодействия двух процессов, после которого последовало продолжение огибающего контура в правой части графика. Наблюдаем такую же структурную навивку с отклонениями недельных колебаний в сторону исходной эллипсовой кривой такта взаимодействия двух процессов (выделено синими штрихами).

## Постановка системы дифференциальных уравнений процесса взаимодействия

Предположим, что данное взаимодействие двух процессов может быть описано с помощью системы дифференциальных уравнений с логистической зависимостью:

$$
  \frac{dx}{dt} = x \cdot \left(\beta_{1} - \alpha_{1} \cdot y \right)
$$

$$
  \frac{dy}{dt} = y \cdot \left(\beta_{2} - \alpha_{2} \cdot x \right)
$$
Данная система иллюстрирует в своём частном случае при $\beta_{2} < 0$ и $\alpha_{2} < 0$ классическую модель "хищник-жертва".

Тогда, система анаморфоз для определения параметров данной системы взаимодействия выглядит следующим образом:

$$
  \frac{dx}{x \cdot dt} = \beta_{1} - \alpha_{1} \cdot y
$$

$$
  \frac{dy}{y \cdot dt} = \beta_{2} - \alpha_{2} \cdot x
$$
Алгоритм определения данных параметров выглядит следующим образом: 

  1. построить в спрямляющих функциональных координатах исходные зависимости,
  2. оценить параметры линейных участков данных процессов в спрямляющих координатах,
  3. сохранить параметры линейных моделей.


```{r, echo=F, dpi = 512}
plot(x = 1:length(time_series_Belarus), y = c(0, log(diff(time_series_Belarus) + 1)),
     col = "red", type = "o", cex = I(0.5), lwd = I(0.5), pch = 19,
     main = "Анализ тактов заболеваемости парного процесса",
     ylab = "Натуральный логарифм заболеваний каждый день, чел",
     xlab = paste("Дни с", df_confirmed$date[1]),
     ylim = c(4, 8),
     xlim = c(60, 500))
lines(x = 1:length(time_series_Egypt), y = c(0, log(diff(time_series_Egypt) + 1)),
      col = "blue", type = "o", cex = I(0.5), lwd = I(0.5), pch = 19)
abline(h = seq(0, 9, 0.5), lwd = I(0.5), lty = 2, col = "grey")
abline(v = seq(0, length(time_series_Egypt) + 10, 25), lwd = I(0.5), lty = 2, col = "grey")
abline(v = maxes_Egypt, col = "orange2")
text(x = maxes_Egypt, y = 3.5, labels = df_confirmed$date[1] - 1 + maxes_Egypt)
abline(v = maxes_Egypt - tau, col = "green3")
text(x = maxes_Egypt - tau, y = 2.5, labels = df_confirmed$date[1] - 1 + maxes_Egypt - tau)
legend(x = 300, y = 2,
       legend = c("LN приросты Беларусь", "LN приросты Египет"),
       col = c("red", "blue"), lty = c(1, 1), pch = c(19, 19))
abline(h = c(4.5, 7.5), col = "blue", lty = 2)
abline(h = c(4.9, 6.9), col = "red", lty = 2)
```

```{r, echo = F, dpi = 512}
plot(y = log(diff(time_series_Egypt) + 1), x = log(diff(time_series_Belarus) + 1),
     xlab = "Динамика заболеваемости в Беларуси в полулогарифмах",
     ylab = "Динамика заболеваемости в Египте в полулогарифмах",
     main = "График фазовой плоскости парной динамики",
     type = "o", 
     pch = 19, 
     lwd = I(0.5),
     cex = I(0.5), ylim = c(4.4, 7.6), xlim = c(4.5, 7.5))

radius_a = 1
radius_b = 1.3
center_x = 6
center_y = 6.1
points(x = c(center_x - radius_a, center_x, center_x + radius_a, center_x, center_x) - 0.1, 
       y = c(center_y, center_y, center_y, center_y + radius_b, center_y - radius_b), pch = 19, cex = I(1), col = "red")
abline(h = c(4.5, 7.5), col = "blue", lty = 2)
abline(v = c(4.9, 6.9), col = "red", lty = 2)
graphics::rect(6.9, 4.5, 9, 7.5, col = "blue", density = I(10))
```

Хорошим тестом для проверки как лага по времени отставания двух процессов друг относительно друга так и зависимости между ними с точки зрения системы дифференциальных уравнений можем оказаться смещение на лаг отставания процесса друг относительно друга в сторону постановки "процесса под процесс" так, чтобы такты двух процессов оказались синхронизированными. В таком случае при подобном смещении на графике фазовой плоскости будут образовываться прямолинейные зависимости, обозначающие высокую степень корреляции двух процессов во времени.

```{r, dpi = 512, echo = F}
plot(x = 1:length(time_series_Belarus) + tau, y = c(0, log(diff(time_series_Belarus) + 1)),
     col = "red", type = "o", cex = I(0.5), lwd = I(0.5), pch = 19,
     main = "Тест на смещение процесса заболеваемости во времени",
     ylab = "Натуральный логарифм заболеваний каждый день, чел",
     xlab = paste("Дни с", df_confirmed$date[1]),
     ylim = c(4, 8),
     xlim = c(60, 500))
lines(x = 1:length(time_series_Egypt), y = c(0, log(diff(time_series_Egypt) + 1)),
      col = "blue", type = "o", cex = I(0.5), lwd = I(0.5), pch = 19)
abline(h = seq(0, 9, 0.5), lwd = I(0.5), lty = 2, col = "grey")
abline(v = seq(0, length(time_series_Egypt) + 10, 25), lwd = I(0.5), lty = 2, col = "grey")
abline(v = maxes_Egypt, col = "orange2")
legend(x = 300, y = 2,
       legend = c("LN приросты Беларусь", "LN приросты Египет"),
       col = c("red", "blue"), lty = c(1, 1), pch = c(19, 19))
abline(h = c(4.5, 7.5), col = "blue", lty = 2)
abline(h = c(4.9, 6.9), col = "red", lty = 2)
```

```{r, echo = F, dpi = 512}
plot(y = log(diff(time_series_Egypt) + 1)[-(1:tau)], 
     x = log(diff(time_series_Belarus) + 1)[-((length(log(diff(time_series_Egypt) + 1)) - tau + 1):length(log(diff(time_series_Egypt) + 1)))],
     xlab = "Динамика заболеваемости в Беларуси в полулогарифмах",
     ylab = "Динамика заболеваемости в Египте в полулогарифмах",
     main = "Тест на смещение процесса заболеваемости во времени",
     type = "p", 
     pch = 19, 
     lwd = I(0.5),
     cex = I(0.5), ylim = c(4.4, 7.6), xlim = c(4.5, 7.5))
abline(h = c(4.5, 7.5), col = "blue", lty = 2)
abline(v = c(4.9, 6.9), col = "red", lty = 2)
graphics::rect(6.9, 4.5, 9, 7.5, col = "blue", density = I(10))

abline(a = 0.5, b = 0.8, col = "red")
abline(a = 1.0, b = 0.8, col = "red")
abline(a = 1.5, b = 0.8, col = "red")
```

Таким образом, так же на качественном уровне нами было получено заключение о высокой корреляции процессов после смещения их друг относительно друга на такт запаздывания.

## Поиск модели системы дифференциального уравнения

Построим графики в спрямляющих координатах для поиска параметров модели взаимодействия двух процессов на основе модели линейной регрессии относительно участков спрямления модели:


```{r Egypt_Belarus, echo = F, out.height=800, out.width=800, dpi = 512}
df1 <- select(df_confirmed, contains("Egypt"))[-(1:70), ]
df2 <- select(df_confirmed, contains("Belarus"))[-(1:70), ]
```


```{r, dpi = 512, echo =F}
plot(x = cumsum(c(0, log(diff(time_series_Belarus) + 1))),
     y = c(0, log(diff(time_series_Egypt) + 1)) / cumsum(c(0, log(diff(time_series_Egypt) + 1))),
     ylim = c(0, 0.02),
     xlim = c(250, 2800),
     xlab = "Belarus",
     ylab = "dEgypt_dt / Egypt",
     main = "X накопленные значения")

alpha_X_red <- -0.000028
beta_X_red <- 0.028
abline(a = beta_X_red, b = alpha_X_red, col = "red")
text(x = 800, y = 0.015, label = paste("alpha_red =", alpha_X_red))
text(x = 800, y = 0.014, label = paste("beta_red =", beta_X_red))


alpha_X_blue <- -0.000001
beta_X_blue <- 0.0053
abline(a = beta_X_blue, b = alpha_X_blue, col = "blue")
text(x = 1500, y = 0.0055, label = paste("alpha_blue =", alpha_X_blue))
text(x = 1500, y = 0.0049, label = paste("beta_blue =", beta_X_blue))
```


```{r, dpi = 512, echo =F}
plot(x = cumsum(c(0, log(diff(time_series_Egypt) + 1))),
     y = c(0, log(diff(time_series_Belarus) + 1)) / cumsum(c(0, log(diff(time_series_Belarus) + 1))),
     ylim = c(0, 0.02),
     xlim = c(250, 2800),
     xlab = "Egypt",
     ylab = "dBelarus_dt / Belarus",
     main = "Y накопленные значения")

alpha_Y_red <- -0.000028
beta_Y_red <- 0.028
abline(a = beta_Y_red, b = alpha_Y_red, col = "red")
text(x = 800, y = 0.015, label = paste("alpha_red =", alpha_Y_red))
text(x = 800, y = 0.014, label = paste("beta_red =", beta_Y_red))


alpha_Y_blue <- -0.000001
beta_Y_blue <- 0.0053
abline(a = beta_Y_blue, b = alpha_Y_blue, col = "blue")
text(x = 2300, y = 0.0055, label = paste("alpha_blue =", alpha_Y_blue))
text(x = 2300, y = 0.0049, label = paste("beta_blue =", beta_Y_blue))

alpha_Y_green <- -0.0000028
beta_Y_green <- 0.0091
abline(a = beta_Y_green, b = alpha_Y_green, col = "green")
text(x = 1500, y = 0.0075, label = paste("alpha_green =", alpha_Y_green))
text(x = 1500, y = 0.0069, label = paste("beta_green =", beta_Y_green))
```


### Модель "красной" линии

$$
  \frac{dx}{x \cdot dt} = 0.028 + 2.8 * 10^{-5} \cdot y
$$

$$
  \frac{dy}{y \cdot dt} = 0.028 + 2.8 * 10^{-5} \cdot x
$$

### Модель "синей" линии

$$
  \frac{dx}{x \cdot dt} = 0.0053 + 10^{-6} \cdot y
$$

$$
  \frac{dy}{y \cdot dt} = 0.0053 + 10^{-6} \cdot x
$$

### Модель "сине-зелёной" линии

$$
  \frac{dx}{x \cdot dt} = 0.0053 + 10^{-6} \cdot y
$$

$$
  \frac{dy}{y \cdot dt} = 0.0091 + 2.8 \cdot 10^{-6} \cdot x
$$

### Модель "красно-зелёной" линии

$$
  \frac{dx}{x \cdot dt} = 0.028 + 2.8 \cdot 10^{-5} \cdot y
$$

$$
  \frac{dy}{y \cdot dt} = 0.0091 + 2.8 \cdot 10^{-6} \cdot x
$$



```{r, echo=FALSE}
S_x = cumsum(c(0, log(diff(time_series_Egypt) + 1)))
S_y = cumsum(c(0, log(diff(time_series_Belarus) + 1)))

S_x_dx <- S_x * (beta_X_blue - alpha_X_blue * S_y)
S_y_dy <- S_y * (beta_Y_green - alpha_Y_green * S_x)
```


```{r, echo = F, dpi = 512}
df_model <- data.frame(Y = diff(S_x_dx), X = (1:length(diff(S_x_dx))))
model_lm_sx <- lm(Y ~ X, data = df_model)

df_real <- data.frame(Y = log(diff(time_series_Egypt) + 1), 
                      X = (1:length(diff(time_series_Egypt) + 1)))
model_Egypt <- lm(Y ~ X, data = df_real)

plot(((diff(S_x_dx) - model_lm_sx$coefficients[1] - 1:length(diff(S_x_dx)) * model_lm_sx$coefficients[2]) * 165 + 
        model_Egypt$coefficients[1] + model_Egypt$coefficients[2] * (1:length(diff(time_series_Egypt)))), 
     col = "blue", type =  "o", cex = I(0.5), lwd = I(0.5), pch = 19,
     main = "Сравнение моделируемой динамики процесса и исходной",
     ylab = "Полулогарифм динамики процесса",
     xlab = paste("Дни с", df_confirmed$date[1]))
lines(log(diff(time_series_Egypt)), 
      col = "red", lwd = I(0.5), type = "o", pch = 19, cex = I(0.5))
abline(h = seq(0, 9, 0.5), lwd = I(0.5), lty = 2, col = "grey")
abline(v = seq(0, length(time_series_Egypt) + 10, 25), lwd = I(0.5), lty = 2, col = "grey")
abline(v = maxes_Egypt, col = "orange2")
legend(x = 300, y = 2,
       legend = c("LN приросты Египет", "LN приросты модель"),
       col = c("red", "blue"), lty = c(1, 1), pch = c(19, 19))

```




```{r}
a <- 0.0035
b <- 0
plot((diff(S_x_dx) - a * (1:length(diff(S_x_dx))) - b) * 10 + 5, type = "l", col = "blue")
lines(log(diff(df1) + 1), col = "red")
```

```{r}
plot(x = 1:length(df2), y = c(0, log(diff(df2) + 1)), 
     col = "red", 
     main = "Заболеваемость в Беларуси, реальная и моделируемая",
     pch = 19,
     type = "o",
     lwd = I(0.5), 
     cex = I(0.5), 
     ylim = c(3.5, 9),
     ylab = "Полулогарифм заболеваемости каждый день",
     xlab = "Даты с ")
lines((diff(S_y_dy) + 0.0165) * 100, 
      col = "blue", 
      type = "o", 
      pch = 19,
      cex = I(0.5),
      lwd = I(0.5))
legend(x = 0, y = 9, 
       legend = c("Реальная заболеваемость", "Моделируемая заболеваемость"), 
       col = c("red", "blue"), 
       lty = c(1, 1), 
       pch = c(19, 19))
```

```{r}
plot(x = 1:length(df2), y = c(0, log(diff(df2) + 1)), 
     col = "red", 
     main = "Заболеваемость в Беларуси, реальная и моделируемая",
     pch = 19,
     type = "o",
     lwd = I(0.5), 
     cex = I(0.5), 
     ylim = c(3.5, 9),
     ylab = "Полулогарифм заболеваемости каждый день",
     xlab = "Даты с ")
lines(((diff(S_y_dy) + 0.0165) * 100) - 4 - 0.75 * 10e-03 * 1:length(diff(S_y_dy)) + 5.5, 
      col = "blue", 
      type = "o", 
      pch = 19,
      cex = I(0.5),
      lwd = I(0.5))
legend(x = 0, y = 9, 
       legend = c("Реальная заболеваемость", "Моделируемая заболеваемость"), 
       col = c("red", "blue"), 
       lty = c(1, 1), 
       pch = c(19, 19))
```


```{r}
plot((diff(S_x_dx) - a * (1:length(diff(S_x_dx))) - b) * 10 + 5, 
     type = "o",
     pch = 19, 
     lwd = I(0.5),
     cex = I(0.5),
     col = "red",
     ylim = c(4, 8))
lines(((diff(S_y_dy) + 0.0165) * 100) - 4 - 0.75 * 10e-03 * 1:length(diff(S_y_dy)) + 5.5,
      type = "o",
      pch = 19,
      lwd = I(0.5),
      cex = I(0.5),
      col = "blue")

plot(x = (diff(S_x_dx) - a * (1:length(diff(S_x_dx))) - b) * 10 + 5, 
     y = ((diff(S_y_dy) + 0.0165) * 100) - 4 - 0.75 * 10e-03 * 1:length(diff(S_y_dy)) + 5.5,
     xlim = c(4, 8),
     ylim = c(4, 8))
radius_a = 1.3
radius_b = 0.8
center_x = 6.15
center_y = 6.3
points(x = c(center_x - radius_a, center_x, center_x + radius_a, center_x, center_x) - 0.1, 
       y = c(center_y, center_y, center_y, center_y + radius_b, center_y - radius_b), pch = 19, cex = I(3), col = "red")
```

```{r}
df1 <- select(df_confirmed, contains("Egypt"))[, ]
df2 <- select(df_confirmed, contains("Russia"))[, ]
```

```{r}
plot(log(diff(df1)))
plot(log(diff(df2)))

plot(log(diff(df1)), ylim = c(3, 11))
lines(log(diff(df2)))
```


```{r}
S_x = cumsum(c(0, log(diff(df1) + 1)))
S_y = cumsum(c(0, log(diff(df2) + 1)))

S_x_dx <- S_x * (beta_X_blue - alpha_X_blue * S_y)
S_y_dy <- S_y * (beta_Y_green - alpha_Y_green * S_x)
```


```{r}
a <- 0.005
b <- 0

plot((diff(S_x_dx) - a * (1:length(diff(S_x_dx))) - b) * 10 + 5, 
     type = "o",
     pch = 19, 
     lwd = I(0.5),
     cex = I(0.5),
     col = "red",
     ylim = c(1, 9))
lines(((diff(S_y_dy) + 0.0165) * 100) - 4 - 1.3 * 10e-03 * 1:length(diff(S_y_dy)) + 5.5,
      type = "o",
      pch = 19,
      lwd = I(0.5),
      cex = I(0.5),
      col = "blue")

plot(x = (diff(S_x_dx) - a * (1:length(diff(S_x_dx))) - b) * 10 + 5, 
     y = ((diff(S_y_dy) + 0.0165) * 100) - 4 - 1.3 * 10e-03 * 1:length(diff(S_y_dy)) + 5.5,
     xlim = c(1, 5),
     ylim = c(6, 7.5))
```
